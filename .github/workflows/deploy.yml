name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ghcr.io/${{ github.actor }}/procure-to-pay-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ghcr.io/${{ github.actor }}/procure-to-pay-frontend:latest
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          timeout: 30s
          script: |
            set -e
            # Change to deployment directory
            if ! cd /opt/procure-to-pay; then
              echo "ERROR: Directory /opt/procure-to-pay does not exist"
              exit 1
            fi
            
            # Configure git remote to use HTTPS instead of SSH
            echo "Configuring git remote to HTTPS..."
            git remote set-url origin https://github.com/${{ github.repository }}.git
            git remote -v | grep -q "https://github.com" || { echo "WARNING: Git remote URL may not have been updated correctly"; }
            
            # Pull latest code (non-blocking - Docker images are source of truth)
            echo "Pulling latest code from repository..."
            if git pull origin main; then
              echo "✓ Successfully pulled latest code"
            else
              echo "⚠ Git pull failed, continuing with existing code (Docker images will be updated)"
            fi
            
            # Verify docker-compose files exist
            if [ ! -f "docker-compose.yml" ]; then
              echo "ERROR: docker-compose.yml not found in /opt/procure-to-pay"
              exit 1
            fi
            
            if [ ! -f "docker-compose.prod.yml" ]; then
              echo "ERROR: docker-compose.prod.yml not found in /opt/procure-to-pay"
              exit 1
            fi
            
            # Set image environment variables
            export BACKEND_IMAGE=ghcr.io/${{ github.actor }}/procure-to-pay-backend:latest
            export FRONTEND_IMAGE=ghcr.io/${{ github.actor }}/procure-to-pay-frontend:latest
            echo "Using images:"
            echo "  BACKEND_IMAGE=$BACKEND_IMAGE"
            echo "  FRONTEND_IMAGE=$FRONTEND_IMAGE"
            
            # Verify docker-compose configuration (using both files)
            echo "Validating docker-compose configuration..."
            if ! docker compose -f docker-compose.yml -f docker-compose.prod.yml config > /dev/null 2>&1; then
              echo "ERROR: docker-compose configuration is invalid"
              docker compose -f docker-compose.yml -f docker-compose.prod.yml config
              exit 1
            fi
            
            # Check if required services exist
            if ! docker compose -f docker-compose.yml -f docker-compose.prod.yml config --services | grep -q "^frontend$"; then
              echo "ERROR: frontend service not found"
              echo "Available services:"
              docker compose -f docker-compose.yml -f docker-compose.prod.yml config --services
              exit 1
            fi
            
            if ! docker compose -f docker-compose.yml -f docker-compose.prod.yml config --services | grep -q "^backend$"; then
              echo "ERROR: backend service not found"
              echo "Available services:"
              docker compose -f docker-compose.yml -f docker-compose.prod.yml config --services
              exit 1
            fi
            
            echo "✓ docker-compose configuration validation passed"
            
            # Login to GitHub Container Registry
            echo "Logging in to GitHub Container Registry..."
            if echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin; then
              echo "✓ Successfully logged in to GitHub Container Registry"
            else
              echo "ERROR: Failed to login to GitHub Container Registry"
              exit 1
            fi
            
            # Pull Docker images (using production compose file)
            echo "Pulling Docker images..."
            if docker compose -f docker-compose.yml -f docker-compose.prod.yml pull backend frontend; then
              echo "✓ Successfully pulled Docker images"
            else
              echo "ERROR: Failed to pull Docker images"
              exit 1
            fi
            
            # Ensure dependencies (db, redis) are running first
            echo "Starting dependencies (db, redis)..."
            if docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d db redis; then
              echo "✓ Dependencies started"
            else
              echo "ERROR: Failed to start dependencies"
              exit 1
            fi
            
            # Wait for dependencies to be healthy
            echo "Waiting for dependencies to be healthy..."
            sleep 10
            
            # Start application services (using production compose file)
            echo "Starting application services..."
            if docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d backend frontend; then
              echo "✓ Services started successfully"
            else
              echo "ERROR: Failed to start services"
              docker compose -f docker-compose.yml -f docker-compose.prod.yml ps
              exit 1
            fi
            
            # Wait a moment for services to be ready
            sleep 5
            
            # Verify services are running
            echo "Verifying services are running..."
            if docker compose -f docker-compose.yml -f docker-compose.prod.yml ps --services --filter "status=running" | grep -q "^backend$"; then
              echo "✓ Backend service is running"
            else
              echo "WARNING: Backend service may not be running"
              docker compose -f docker-compose.yml -f docker-compose.prod.yml ps backend
            fi
            
            if docker compose -f docker-compose.yml -f docker-compose.prod.yml ps --services --filter "status=running" | grep -q "^frontend$"; then
              echo "✓ Frontend service is running"
            else
              echo "WARNING: Frontend service may not be running"
              docker compose -f docker-compose.yml -f docker-compose.prod.yml ps frontend
            fi
            
            # Migrations and static files are handled automatically by docker-compose command
            # Just wait for services to be fully ready
            sleep 10
            
            # Verify services are healthy
            echo "Final health check..."
            docker compose -f docker-compose.yml -f docker-compose.prod.yml ps
            echo "✓ Deployment completed successfully"

